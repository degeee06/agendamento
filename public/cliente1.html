<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Agendamento</title>
<style>
/* --- Mantém todos os estilos existentes --- */
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: #333; min-height: 100vh; padding: 20px; display: flex; justify-content: center; align-items: center; }
.container { width: 100%; max-width: 800px; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; }
header { background: #2c3e50; color: white; padding: 20px; text-align: center; }
header h1 { margin-bottom: 10px; font-size: 28px; }
header p { opacity: 0.8; }
.progress-bar { display: flex; background: #f1f1f1; padding: 10px; }
.progress-step { flex: 1; text-align: center; padding: 10px; font-weight: bold; position: relative; }
.progress-step.active { color: #3498db; }
.progress-step::after { content: "→"; position: absolute; right: -10px; top: 50%; transform: translateY(-50%); }
.progress-step:last-child::after { content: none; }
.section { padding: 30px; display: none; }
.section.active { display: block; animation: fadeIn 0.5s ease; }
h2 { color: #2c3e50; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #eee; }
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
input, select { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
input:focus, select:focus { border-color: #3498db; outline: none; }
button { background: #3498db; color: white; border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; width: 100%; margin-top: 10px; transition: background 0.3s; }
button:hover { background: #2980b9; }
button.secondary { background: #95a5a6; }
button.secondary:hover { background: #7f8c8d; }
#pix-container { text-align: center; margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 10px; }
#qr-code-image { max-width: 250px; border: 1px solid #ddd; padding: 10px; background: white; border-radius: 8px; }
.expiration { color: #e74c3c; font-weight: bold; margin: 15px 0; font-size: 18px; }
.success-msg { background-color: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
.confirmation-details { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
.confirmation-details p { margin-bottom: 10px; font-size: 17px; }
.confirmation-details strong { color: #2c3e50; }
footer { text-align: center; padding: 20px; background: #f1f1f1; color: #7f8c8d; }
.hidden { display: none; }
.error { background-color: #f8d7da; color: #721c24; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: center; }
.countdown-warning { color: #e74c3c; font-weight: bold; }
@keyframes fadeIn { from { opacity:0; transform: translateY(20px);} to { opacity:1; transform: translateY(0);} }
@media (max-width:768px) { body { padding:10px;} .container { border-radius:10px;} .section { padding:20px;} .progress-step { font-size:14px;} #qr-code-image { max-width:200px; } }
</style>
</head>
<body>
<div class="container">
<header>
    <h1>Agendamento de Serviços</h1>
    <p>Realize seu pagamento e agendamento de forma rápida e segura</p>
</header>

<div class="progress-bar">
    <div class="progress-step active" id="step-1">1. Pagamento</div>
    <div class="progress-step" id="step-2">2. Agendamento</div>
    <div class="progress-step" id="step-3">3. Confirmação</div>
</div>

<main>
    <section id="payment-section" class="section active">
        <h2>Pagamento via PIX</h2>
        <form id="payment-form">
            <div class="form-group">
                <label for="Nome">Nome Completo:</label>
                <input type="text" name="Nome" required>
            </div>
            <div class="form-group">
                <label for="Email">E-mail:</label>
                <input type="email" name="Email" required>
            </div>
            <div class="form-group">
                <label for="Telefone">Telefone:</label>
                <input type="tel" name="Telefone" required>
            </div>
            <div class="form-group">
                <label for="Data">Data:</label>
                <input type="date" name="Data" required>
            </div>
            <div class="form-group">
                <label for="Horario">Horário:</label>
                <select name="Horario" required>
                    <option value="">Selecione um horário</option>
                </select>
            </div>
            <button type="submit">Agendar e Gerar PIX</button>
            <div class="mt-2 flex items-center justify-center hidden" id="agendarSpinner">Carregando...</div>
        </form>
        <div id="pixArea" class="mt-4"></div>
    </section>

    <section id="confirmation-section" class="section">
        <h2>Agendamento Confirmado!</h2>
        <div class="confirmation-details">
            <p><strong>Nome:</strong> <span id="confirm-name"></span></p>
            <p><strong>Data:</strong> <span id="confirm-date"></span></p>
            <p><strong>Horário:</strong> <span id="confirm-time"></span></p>
            <p><strong>Telefone:</strong> <span id="confirm-phone"></span></p>
        </div>
        <button id="new-schedule" class="secondary">Fazer Novo Agendamento</button>
    </section>
</main>

<footer>
    <p>Dúvidas? Entre em contato: contato@empresa.com | (11) 9999-9999</p>
</footer>
</div>

<script src="https://unpkg.com/feather-icons"></script>
<script>
const form = document.getElementById('payment-form');
const cliente = location.pathname.split('/')[1] || 'default';
let currentPaymentId = null;
let paymentCheckInterval = null;
let paymentExpiresAt = null;

// ---------- FUNÇÕES DE TEMPO ----------
function formatTimeRemaining(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = seconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function startPaymentTimer(expiresAt) {
    if (paymentCheckInterval) clearInterval(paymentCheckInterval);
    const countdownElement = document.getElementById('countdownTimer');
    paymentCheckInterval = setInterval(async () => {
        const now = new Date();
        const expires = new Date(expiresAt);
        const timeRemaining = Math.floor((expires - now)/1000);

        if(timeRemaining <=0) {
            clearInterval(paymentCheckInterval);
            if(countdownElement) countdownElement.innerHTML = 'Tempo esgotado!';
            return;
        }
        if(countdownElement) countdownElement.textContent = `Tempo restante: ${formatTimeRemaining(timeRemaining)}`;
        if(timeRemaining < 60) countdownElement.classList.add('countdown-warning');
        else countdownElement.classList.remove('countdown-warning');
    },1000);
}

// ---------- VERIFICAÇÃO DE PAGAMENTO ----------
async function checkPaymentStatus(paymentId) {
    try {
        const statusResponse = await fetch(`/check-payment/${paymentId}`);
        if(!statusResponse.ok) throw new Error('Erro ao verificar pagamento');
        const statusData = await statusResponse.json();

        if(statusData.status === 'approved') {
            clearInterval(paymentCheckInterval);
            alert('Pagamento aprovado! Agendamento realizado.');
            return true;
        }
        return false;
    } catch(err){ console.error(err); return false; }
}

// ---------- SUBMISSÃO DO FORMULÁRIO ----------
form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const formData = new FormData(form);
    const dataToSend = {};
    formData.forEach((v,k)=>dataToSend[k]=v);

    if(!dataToSend.Nome || !dataToSend.Email || !dataToSend.Telefone || !dataToSend.Data || !dataToSend.Horario){
        alert("Preencha todos os campos");
        return;
    }

    // Criar pagamento PIX
    try {
        const pagamentoResponse = await fetch(`/create-pix/${cliente}`, {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({
                amount: 0.01,
                description: `Agendamento - ${dataToSend.Nome}`,
                email: dataToSend.Email
            })
        });
        const pagamentoData = await pagamentoResponse.json();
        currentPaymentId = pagamentoData.payment_id;
        paymentExpiresAt = pagamentoData.expires_at;

        const pixDiv = document.getElementById('pixArea');
        pixDiv.innerHTML = `
            <h3 class="text-center mb-3">Pagamento via PIX</h3>
            <img src="data:image/png;base64,${pagamentoData.qr_code_base64}" class="mx-auto mb-4 w-48 h-48"/>
            <div id="countdownTimer" class="countdown-timer">Tempo restante: ${formatTimeRemaining(Math.floor((new Date(paymentExpiresAt)-new Date())/1000))}</div>
            <button id="confirmPaymentBtn" class="px-4 py-2 bg-green-600 rounded hover:bg-green-700 mt-2">Já efetuei o pagamento</button>
        `;
        feather.replace();
        startPaymentTimer(paymentExpiresAt);

        document.getElementById('confirmPaymentBtn').addEventListener('click', async ()=>{
            const confirmed = await checkPaymentStatus(currentPaymentId);
            if(!confirmed) alert("Pagamento ainda não confirmado.");
        });

    } catch(err){ console.error(err); alert('Erro ao processar pagamento'); }
});
</script>
</body>
</html>
