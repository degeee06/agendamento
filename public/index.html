<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Agendamento VIP</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }
.glass-card { background: rgba(255,255,255,0.05); backdrop-filter: blur(16px); border:1px solid rgba(255,255,255,0.1); box-shadow:0 8px 32px rgba(0,0,0,0.1);}
.status-pendente { color:#fbbf24; background:rgba(251,191,36,0.15); padding:2px 6px; border-radius:6px; font-weight:600; }
.status-confirmado { color:#34d399; background:rgba(52,211,153,0.15); padding:2px 6px; border-radius:6px; font-weight:600; }
.status-cancelado { color:#f87171; background:rgba(248,113,113,0.15); padding:2px 6px; border-radius:6px; font-weight:600; }
.tab-dia.active { box-shadow:0 4px 6px -1px rgba(0,0,0,0.1),0 2px 4px -1px rgba(0,0,0,0.06); }
.agendamento-card { transition:all 0.3s ease; }
.agendamento-card:hover { transform:translateY(-2px); box-shadow:0 10px 15px -3px rgba(0,0,0,0.1),0 4px 6px -2px rgba(0,0,0,0.05); }
.truncate { overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:220px; display:inline-block; vertical-align:middle; }
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-800 to-slate-900 text-white">
<div class="container mx-auto px-4 py-8 max-w-6xl">

<header class="text-center mb-12" data-aos="fade-down">
  <h1 class="text-4xl md:text-5xl font-bold mb-3 bg-clip-text text-transparent bg-gradient-to-r from-indigo-400 to-cyan-300">Agendamento VIP</h1>
  <p class="text-lg opacity-90">Gerencie seus compromissos com uma interface moderna</p>
</header>

<!-- Login -->
<div id="loginSection" class="glass-card rounded-2xl p-8 mb-8" data-aos="fade-up">
  <h2 class="text-2xl font-semibold text-center mb-6">Acesso ao Sistema</h2>
  <input type="text" id="tokenInput" placeholder="Cole seu token" class="w-full p-3 rounded mb-3 bg-white/10">
  <button id="loginBtn" class="w-full bg-gradient-to-r from-indigo-500 to-cyan-500 py-3 rounded">Entrar</button>
</div>

<!-- VIP Section -->
<div id="vipSection" class="glass-card rounded-2xl p-8 mb-8 hidden" data-aos="fade-up">
  <div class="flex items-center justify-center mb-6">
    <div class="p-3 rounded-full bg-gradient-to-br from-yellow-500 to-orange-500 shadow-lg">
      <i data-feather="star" class="w-6 h-6 text-white"></i>
    </div>
  </div>
  <h2 class="text-2xl font-semibold text-center mb-6">Seja VIP üöÄ</h2>
  <p class="text-center mb-4 opacity-90">Agende ilimitado e confirme instantaneamente!</p>
  <div class="flex justify-center">
    <button id="vipBtn" class="bg-gradient-to-r from-yellow-500 to-orange-500 text-white py-3 px-6 rounded-lg">Seja VIP (R$ 29,90)</button>
  </div>
  <div id="pixContainer" class="mt-6 text-center hidden">
    <h3 class="font-medium mb-2">Pague via PIX</h3>
    <img id="pixQR" class="mx-auto w-64 h-64 rounded-lg shadow-lg border border-white/20" />
    <p class="mt-2 text-sm opacity-80">Escaneie o QR Code no seu banco para ativar VIP</p>
  </div>
</div>

<!-- Formul√°rio de Agendamento -->
<form id="agendamentoForm" style="display:none;" class="glass-card rounded-2xl p-8 mb-8" data-aos="fade-up">
  <h2 class="text-2xl font-semibold text-center mb-6">Novo Agendamento</h2>
  <input type="text" name="Nome" placeholder="Seu nome" required class="w-full p-2 rounded mb-3 bg-white/10">
  <input type="email" name="Email" placeholder="seu@email.com" required class="w-full p-2 rounded mb-3 bg-white/10">
  <input type="text" name="Telefone" placeholder="(00) 00000-0000" required class="w-full p-2 rounded mb-3 bg-white/10">
  <input type="date" name="Data" required class="w-full p-2 rounded mb-3 bg-white/10">
  <input type="time" name="Horario" required class="w-full p-2 rounded mb-3 bg-white/10">
  <button type="submit" class="w-full bg-gradient-to-r from-indigo-500 to-cyan-500 py-2 rounded">Agendar</button>
</form>

<!-- Filtros e Lista -->
<div id="filtersSection" class="glass-card rounded-2xl p-4 mb-6 hidden" data-aos="fade-up">
  <div class="flex gap-3 items-center">
    <input id="searchInput" placeholder="Pesquisar por nome ou email" class="flex-1 p-2 rounded bg-white/10" />
    <select id="statusFilter" class="p-2 rounded bg-white/10">
      <option value="">Todos</option>
      <option value="pendente">Pendente</option>
      <option value="confirmado">Confirmado</option>
      <option value="cancelado">Cancelado</option>
    </select>
  </div>
  <div id="diasTabs" class="flex gap-2 mt-4 hidden">
    <div class="tab-dia p-2 rounded bg-white/10 cursor-pointer" data-dia="1">Seg</div>
    <div class="tab-dia p-2 rounded bg-white/10 cursor-pointer" data-dia="2">Ter</div>
    <div class="tab-dia p-2 rounded bg-white/10 cursor-pointer" data-dia="3">Qua</div>
    <div class="tab-dia p-2 rounded bg-white/10 cursor-pointer" data-dia="4">Qui</div>
    <div class="tab-dia p-2 rounded bg-white/10 cursor-pointer" data-dia="5">Sex</div>
    <div class="tab-dia p-2 rounded bg-white/10 cursor-pointer" data-dia="6">S√°b</div>
  </div>
</div>

<div id="meusAgendamentos" class="glass-card rounded-2xl p-6 hidden" data-aos="fade-up">
  Nenhum agendamento
</div>

<div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

<script type="module">
const cliente = window.location.pathname.split("/")[1] || "";
let userToken = null;
let agendamentosCache = [];
let diaSelecionado = 1;

const loginBtn = document.getElementById("loginBtn");
const tokenInput = document.getElementById("tokenInput");
const form = document.getElementById("agendamentoForm");
const meusAgendamentos = document.getElementById("meusAgendamentos");
const vipSection = document.getElementById("vipSection");
const vipBtn = document.getElementById("vipBtn");
const pixContainer = document.getElementById("pixContainer");
const pixQR = document.getElementById("pixQR");
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const filtersSection = document.getElementById("filtersSection");
const diasTabs = document.getElementById("diasTabs");
const loginSection = document.getElementById("loginSection");

feather.replace();
AOS.init();

function toast(msg, color="#34d399") {
  const t = document.createElement("div");
  t.innerText = msg;
  t.className = `p-3 rounded shadow text-white font-semibold bg-[${color}]`;
  document.getElementById("toast-container").appendChild(t);
  setTimeout(()=>t.remove(),3000);
}

loginBtn.addEventListener("click", ()=>{
  const token = tokenInput.value.trim();
  if(!token) return toast("Digite um token v√°lido","red");
  userToken = token;
  loginSection.style.display="none";
  form.style.display="block";
  filtersSection.style.display="block";
  meusAgendamentos.style.display="block";
  vipSection.style.display="block";
  carregarAgendamentos();
});

async function carregarAgendamentos() {
  const res = await fetch(`/agendar/${cliente}`, {
    headers: { Authorization: `Bearer ${userToken}` }
  });
  if(res.ok){
    agendamentosCache = await res.json();
    renderAgendamentos();
  } else toast("Erro ao carregar agendamentos","red");
}

function renderAgendamentos(){
  const search = searchInput.value.toLowerCase();
  const status = statusFilter.value;
  const filtered = agendamentosCache.filter(a=>{
    const matchSearch = a.Nome.toLowerCase().includes(search) || a.Email.toLowerCase().includes(search);
    const matchStatus = status ? a.Status===status : true;
    return matchSearch && matchStatus;
  });
  if(filtered.length===0){
    meusAgendamentos.innerHTML="Nenhum agendamento";
    return;
  }
  meusAgendamentos.innerHTML="";
  filtered.forEach(a=>{
    const card = document.createElement("div");
    card.className="agendamento-card glass-card p-3 mb-3 rounded flex justify-between items-center";
    card.innerHTML=`
      <div class="truncate">${a.Nome} (${a.Email}) - ${a.Data} ${a.Horario}</div>
      <div class="flex gap-2 items-center">
        <span class="status-${a.Status}">${a.Status}</span>
        ${a.Status==="pendente" ? `<button onclick="confirmar('${a.id}')">‚úîÔ∏è</button><button onclick="cancelar('${a.id}')">‚ùå</button>` : ""}
      </div>
    `;
    meusAgendamentos.appendChild(card);
  });
}

async function confirmar(id){
  const res = await fetch(`/agendamentos/${cliente}/confirmar/${id}`, {
    method:"POST",
    headers: { Authorization:`Bearer ${userToken}` }
  });
  if(res.ok){ toast("Confirmado!"); carregarAgendamentos(); }
  else toast("Erro ao confirmar","red");
}

async function cancelar(id){
  const res = await fetch(`/agendamentos/${cliente}/cancelar/${id}`, {
    method:"POST",
    headers: { Authorization:`Bearer ${userToken}` }
  });
  if(res.ok){ toast("Cancelado"); carregarAgendamentos(); }
  else toast("Erro ao cancelar","red");
}

form.addEventListener("submit", async e=>{
  e.preventDefault();
  const data = Object.fromEntries(new FormData(form));
  const res = await fetch(`/agendar/${cliente}`,{
    method:"POST",
    headers: { "Content-Type":"application/json", Authorization:`Bearer ${userToken}` },
    body: JSON.stringify(data)
  });
  if(res.ok){ toast("Agendado!"); form.reset(); carregarAgendamentos(); }
  else { const err=await res.json(); toast(err.msg || "Erro","red"); }
});

vipBtn.addEventListener("click", async ()=>{
  // Aqui voc√™ pode chamar rota do server.js para gerar PIX
  const res = await fetch(`/vip/${cliente}`,{
    method:"POST",
    headers:{ Authorization:`Bearer ${userToken}` }
  });
  if(res.ok){
    const { qrCodeURL } = await res.json();
    pixQR.src = qrCodeURL;
    pixContainer.style.display="block";
  } else toast("Erro ao gerar VIP","red");
});

searchInput.addEventListener("input", renderAgendamentos);
statusFilter.addEventListener("change", renderAgendamentos);

document.querySelectorAll(".tab-dia").forEach(tab=>{
  tab.addEventListener("click", e=>{
    diaSelecionado = parseInt(tab.dataset.dia);
    document.querySelectorAll(".tab-dia").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    renderAgendamentos();
  });
});
</script>

</div>
</body>
</html>
