<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agendamento VIP</title>
  <script src="https://cdn.jsdelivr.net/npm/supabase@2.10.0/dist/supabase.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.3.2/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-6">

  <div class="max-w-xl mx-auto bg-white shadow-md rounded p-6">
    <h1 class="text-2xl font-bold mb-4">Agendamento VIP</h1>

    <!-- LOGIN -->
    <div id="login-section" class="mb-4">
      <input id="email" type="email" placeholder="Email" class="border p-2 w-full mb-2 rounded">
      <input id="password" type="password" placeholder="Senha" class="border p-2 w-full mb-2 rounded">
      <button id="login-btn" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Entrar</button>
      <p id="login-msg" class="text-red-500 mt-2"></p>
    </div>

    <!-- FORM AGENDAMENTO -->
    <div id="form-section" class="hidden">
      <input id="nome" type="text" placeholder="Nome" class="border p-2 w-full mb-2 rounded">
      <input id="telefone" type="text" placeholder="Telefone" class="border p-2 w-full mb-2 rounded">
      <input id="data" type="date" class="border p-2 w-full mb-2 rounded">
      <input id="horario" type="time" class="border p-2 w-full mb-2 rounded">
      <button id="agendar-btn" class="bg-green-500 text-white px-4 py-2 rounded w-full mb-2">Agendar</button>
      <button id="vip-btn" class="bg-yellow-500 text-white px-4 py-2 rounded w-full">Gerar VIP</button>
      <p id="form-msg" class="text-red-500 mt-2"></p>
    </div>

    <div id="info-section" class="mt-4 text-gray-700"></div>
  </div>

<script>
  const SUPABASE_URL = 'COLE_SUA_SUPABASE_URL';
  const SUPABASE_ANON_KEY = 'COLE_SUA_ANON_KEY';
  const CLIENTE_ID = 'cliente1'; // seu cliente_id no Supabase

  const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let accessToken = null;

  // LOGIN
  document.getElementById('login-btn').addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
      document.getElementById('login-msg').textContent = error.message;
      return;
    }
    accessToken = data.session.access_token;
    document.getElementById('login-section').classList.add('hidden');
    document.getElementById('form-section').classList.remove('hidden');
    document.getElementById('info-section').textContent = `Logado como ${email}`;
  });

  // AGENDAR
  document.getElementById('agendar-btn').addEventListener('click', async () => {
    const Nome = document.getElementById('nome').value;
    const Telefone = document.getElementById('telefone').value;
    const Data = document.getElementById('data').value;
    const Horario = document.getElementById('horario').value;

    const Email = supabase.auth.getSession().data?.session?.user.email || '';

    if (!Nome || !Telefone || !Data || !Horario) {
      document.getElementById('form-msg').textContent = "Preencha todos os campos";
      return;
    }

    const res = await fetch(`/agendar/${CLIENTE_ID}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + accessToken
      },
      body: JSON.stringify({ Nome, Email, Telefone, Data, Horario })
    });

    const result = await res.json();
    if (!res.ok) {
      document.getElementById('form-msg').textContent = result.msg || result.error;
    } else {
      document.getElementById('form-msg').textContent = result.msg;
    }
  });

  // GERAR VIP
  document.getElementById('vip-btn').addEventListener('click', async () => {
    const Email = supabase.auth.getSession().data?.session?.user.email || '';
    const amount = 10; // valor fixo VIP
    const description = 'VIP 30 dias';

    const res = await fetch('/create-pix', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ amount, description, email: Email })
    });

    const data = await res.json();
    if (data.qr_code_base64) {
      const qrImg = `<img src="data:image/png;base64,${data.qr_code_base64}" class="mt-2 mx-auto"/>`;
      document.getElementById('info-section').innerHTML = `PIX gerado: <br>${qrImg}`;
    } else {
      document.getElementById('info-section').textContent = 'Erro ao gerar VIP';
    }
  });
</script>

</body>
</html>
