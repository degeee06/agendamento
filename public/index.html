<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Agendamentos</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-6">
  <h1 class="text-3xl font-bold mb-6 text-center">Meus Agendamentos</h1>

  <!-- Formulário -->
  <div id="form-agendamento" class="mb-6 p-6 bg-white rounded shadow max-w-md mx-auto">
    <input id="nome" placeholder="Nome" class="border p-2 mb-2 w-full rounded"/>
    <input id="email" placeholder="Email" class="border p-2 mb-2 w-full rounded"/>
    <input id="telefone" placeholder="Telefone" class="border p-2 mb-2 w-full rounded"/>
    <input id="data" type="date" class="border p-2 mb-2 w-full rounded"/>
    <input id="horario" type="time" class="border p-2 mb-2 w-full rounded"/>
    <button id="btn-agendar" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Agendar</button>
  </div>

  <!-- Lista -->
  <div id="agendamentos-list" class="max-w-xl mx-auto space-y-4"></div>

  <!-- Modal Reagendar -->
  <div id="modal-reagendar" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center hidden">
    <div class="bg-white p-6 rounded shadow w-80">
      <h2 class="text-xl font-bold mb-4">Reagendar</h2>
      <input id="novaData" type="date" class="border p-2 mb-2 w-full rounded"/>
      <input id="novoHorario" type="time" class="border p-2 mb-4 w-full rounded"/>
      <div class="flex justify-end space-x-2">
        <button id="cancel-reagendar" class="px-4 py-2 rounded border">Cancelar</button>
        <button id="confirm-reagendar" class="px-4 py-2 bg-green-500 text-white rounded">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    let cliente = null;
    let userToken = null;
    let agendamentoParaReagendar = null;

    // pega cliente da URL (/cliente123)
    function getClienteFromPath() {
      const parts = window.location.pathname.split("/");
      return parts[1] || null;
    }

    // obtém token do localStorage (setado no login via backend)
    function getToken() {
      return localStorage.getItem("token");
    }

    async function fetchAgendamentos() {
      const res = await fetch(`/meus-agendamentos/${cliente}`, {
        headers: { Authorization: `Bearer ${userToken}` }
      });
      const data = await res.json();
      renderAgendamentos(data.agendamentos || []);
    }

    function renderAgendamentos(agendamentos) {
      const container = document.getElementById("agendamentos-list");
      container.innerHTML = "";
      agendamentos.forEach(a => {
        const div = document.createElement("div");
        div.className = "p-4 bg-white rounded shadow flex justify-between items-center";
        div.innerHTML = `
          <div>
            <strong>${a.nome}</strong> | ${a.email || ""} | ${a.telefone || ""}<br/>
            ${a.data} às ${a.horario} | Status: ${a.status}
          </div>
          <div class="space-x-2">
            ${a.status !== "confirmado" ? `<button onclick="confirmar('${a.id}')" class="bg-green-500 text-white px-2 py-1 rounded">Confirmar</button>` : ""}
            ${a.status !== "cancelado" ? `<button onclick="cancelar('${a.id}')" class="bg-red-500 text-white px-2 py-1 rounded">Cancelar</button>` : ""}
            <button onclick="abrirReagendar('${a.id}')" class="bg-yellow-500 text-white px-2 py-1 rounded">Reagendar</button>
          </div>
        `;
        container.appendChild(div);
      });
    }

    async function agendar() {
      const agendamento = {
        nome: document.getElementById("nome").value,
        email: document.getElementById("email").value,
        telefone: document.getElementById("telefone").value,
        data: document.getElementById("data").value,
        horario: document.getElementById("horario").value
      };

      const res = await fetch(`/agendar/${cliente}`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          Authorization: `Bearer ${userToken}`
        },
        body: JSON.stringify(agendamento)
      });
      const data = await res.json();
      alert(data.msg);
      fetchAgendamentos();
    }

    async function cancelar(id) {
      const res = await fetch(`/cancelar/${cliente}/${id}`, {
        method: "POST",
        headers: { Authorization: `Bearer ${userToken}` }
      });
      const data = await res.json();
      alert(data.msg);
      fetchAgendamentos();
    }

    async function confirmar(id) {
      const res = await fetch(`/confirmar/${cliente}/${id}`, {
        method: "POST",
        headers: { Authorization: `Bearer ${userToken}` }
      });
      const data = await res.json();
      alert(data.msg);
      fetchAgendamentos();
    }

    function abrirReagendar(id) {
      agendamentoParaReagendar = id;
      document.getElementById("modal-reagendar").classList.remove("hidden");
    }

    document.getElementById("cancel-reagendar").addEventListener("click", () => {
      document.getElementById("modal-reagendar").classList.add("hidden");
    });

    document.getElementById("confirm-reagendar").addEventListener("click", async () => {
      const novaData = document.getElementById("novaData").value;
      const novoHorario = document.getElementById("novoHorario").value;
      if (!novaData || !novoHorario) { alert("Preencha data e horário"); return; }

      const res = await fetch(`/reagendar/${cliente}/${agendamentoParaReagendar}`, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          Authorization: `Bearer ${userToken}` 
        },
        body: JSON.stringify({ novaData, novoHorario })
      });

      const data = await res.json();
      alert(data.msg);
      document.getElementById("modal-reagendar").classList.add("hidden");
      fetchAgendamentos();
    });

    document.getElementById("btn-agendar").addEventListener("click", agendar);

    // inicialização
    (async () => {
      cliente = getClienteFromPath();
      userToken = getToken();
      if (!cliente) {
        alert("Cliente não encontrado na URL");
        return;
      }
      if (!userToken) {
        alert("Token não encontrado. Faça login antes.");
        return;
      }
      fetchAgendamentos();
    })();
  </script>
</body>
</html>
