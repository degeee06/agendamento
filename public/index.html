<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Controle de Agendamentos</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            color: #1e293b;
            font-size: 1.8rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 2rem;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 0.5rem;
        }

        .nav-item:hover {
            background: #f1f5f9;
        }

        .nav-item.active {
            background: #3b82f6;
            color: white;
        }

        .main-content {
            min-height: 600px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #374151;
        }

        .form-select, .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .time-slots {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .time-slot {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .time-slot.selected {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .time-slot.ocupado {
            background: #fef2f2;
            color: #dc2626;
            border-color: #fca5a5;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .calendar-header {
            background: #1e293b;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: 600;
        }

        .calendar-day {
            background: white;
            padding: 1rem;
            min-height: 120px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background: #f8fafc;
        }

        .calendar-day.blocked {
            background: #fef2f2;
            color: #dc2626;
        }

        .calendar-day.today {
            background: #dbeafe;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .agendamentos-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .agendamento-item {
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .status {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status.pendente {
            background: #fef3c7;
            color: #d97706;
        }

        .status.confirmado {
            background: #d1fae5;
            color: #065f46;
        }

        .status.cancelado {
            background: #fee2e2;
            color: #dc2626;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #64748b;
        }

        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .success {
            background: #f0fdf4;
            color: #16a34a;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Painel Admin - Controle de Agendamentos</h1>
            <div class="user-info">
                <span id="userEmail">Carregando...</span>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="sidebar">
                <div class="nav-item active" onclick="showSection('dashboard')">
                    <i data-lucide="dashboard"></i>
                    Dashboard
                </div>
                <div class="nav-item" onclick="showSection('config-geral')">
                    <i data-lucide="settings"></i>
                    Configuração Geral
                </div>
                <div class="nav-item" onclick="showSection('calendario')">
                    <i data-lucide="calendar"></i>
                    Calendário
                </div>
                <div class="nav-item" onclick="showSection('agendamentos')">
                    <i data-lucide="list"></i>
                    Agendamentos
                </div>
            </div>

            <div class="main-content">
                <!-- Dashboard -->
                <div id="dashboard-section">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="statHoje">0</div>
                            <div class="stat-label">Agendamentos Hoje</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="statPendentes">0</div>
                            <div class="stat-label">Pendentes</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Disponibilidade de Hoje</h3>
                        </div>
                        <div id="disponibilidade-hoje"></div>
                    </div>
                </div>

                <!-- Configuração Geral -->
                <div id="config-geral-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Configuração Geral de Horários</h3>
                        </div>
                        <form id="configGeralForm">
                            <div class="form-group">
                                <label class="form-label">Dias da Semana Disponíveis</label>
                                <div class="checkbox-grid" id="dias-semana-checkboxes"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Horários Disponíveis</label>
                                <div class="time-slots" id="horarios-disponiveis"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Intervalo entre Agendamentos (minutos)</label>
                                <input type="number" class="form-input" id="intervalo-minutos" min="15" max="240" step="15">
                            </div>

                            <div class="form-group">
                                <label class="form-label">Máximo de Agendamentos por Dia</label>
                                <input type="number" class="form-input" id="max-agendamentos-dia" min="1" max="50">
                            </div>

                            <button type="submit" class="btn btn-primary">Salvar Configuração</button>
                        </form>
                    </div>
                </div>

                <!-- Calendário -->
                <div id="calendario-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Controle de Datas e Horários</h3>
                        </div>
                        <div id="calendar-controls">
                            <div class="form-group">
                                <label class="form-label">Selecione uma Data</label>
                                <input type="date" class="form-input" id="data-selecionada">
                            </div>
                            <div id="config-data-especifica"></div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Próximos 30 Dias</h3>
                        </div>
                        <div id="calendario-30dias"></div>
                    </div>
                </div>

                <!-- Agendamentos -->
                <div id="agendamentos-section" class="hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Agendamentos do Dia</h3>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data</label>
                            <input type="date" class="form-input" id="data-agendamentos">
                        </div>
                        <div id="lista-agendamentos" class="agendamentos-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuração Supabase - AGUARDA CARREGAMENTO COMPLETO
        let supabase;
        let currentUser = null;
        let clienteId = null;
        let configGeral = null;

        // Inicialização após carregamento completo da página
        document.addEventListener('DOMContentLoaded', async () => {
            await initializeApp();
        });

        async function initializeApp() {
            try {
                // Inicializa Supabase apenas após o DOM estar pronto
                supabase = supabase.createClient(
                    window.location.origin.replace('admin', ''), // Usa a mesma origem do backend
                    await getAnonKey() // Busca a chave anônima do backend
                );
                
                await checkAuth();
                await loadDashboard();
                await loadConfigGeral();
                Lucide.createIcons();
                
                // Configura event listeners
                setupEventListeners();
                
            } catch (error) {
                console.error('Erro na inicialização:', error);
                showError('Erro ao inicializar aplicação: ' + error.message);
            }
        }

        // Busca a chave anônima do backend
        async function getAnonKey() {
            try {
                const response = await fetch('/health');
                // Para desenvolvimento, use uma chave fixa ou configure via environment
                return 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';
            } catch {
                // Fallback para desenvolvimento
                return 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0';
            }
        }

        function setupEventListeners() {
            // Configuração geral
            document.getElementById('configGeralForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await salvarConfigGeral();
            });

            // Data selecionada no calendário
            document.getElementById('data-selecionada').addEventListener('change', async () => {
                await loadConfigDataEspecifica();
            });

            // Data para agendamentos
            document.getElementById('data-agendamentos').addEventListener('change', async () => {
                await carregarAgendamentos();
            });

            // Define data padrão para agendamentos
            document.getElementById('data-agendamentos').value = new Date().toISOString().split('T')[0];
        }

        // Autenticação
        async function checkAuth() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) {
                    window.location.href = '/';
                    return;
                }

                currentUser = session.user;
                clienteId = currentUser.user_metadata?.cliente_id;
                document.getElementById('userEmail').textContent = currentUser.email;

                if (!clienteId) {
                    showError('Usuário sem cliente_id configurado');
                    return;
                }
            } catch (error) {
                console.error('Erro na autenticação:', error);
                window.location.href = '/';
            }
        }

        async function logout() {
            try {
                await supabase.auth.signOut();
                window.location.href = '/';
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
            }
        }

        // Navegação
        function showSection(sectionName) {
            // Remove classe active de todos os itens
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Esconde todas as seções
            document.querySelectorAll('[id$="-section"]').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Ativa item clicado e mostra seção correspondente
            event.currentTarget.classList.add('active');
            document.getElementById(`${sectionName}-section`).classList.remove('hidden');

            // Carrega dados específicos da seção
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'config-geral':
                    loadConfigGeral();
                    break;
                case 'calendario':
                    loadCalendario();
                    break;
                case 'agendamentos':
                    carregarAgendamentos();
                    break;
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const token = await getToken();
                const response = await fetch(`/admin/${clienteId}/dashboard`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar dashboard');
                
                const data = await response.json();
                
                document.getElementById('statHoje').textContent = data.estatisticas.hoje;
                document.getElementById('statPendentes').textContent = data.estatisticas.pendentes;
                
                await loadDisponibilidadeHoje();
            } catch (error) {
                showError('Erro ao carregar dashboard: ' + error.message);
            }
        }

        async function loadDisponibilidadeHoje() {
            const hoje = new Date().toISOString().split('T')[0];
            try {
                const token = await getToken();
                const response = await fetch(`/api/horarios-disponiveis/${clienteId}?data=${hoje}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar disponibilidade');
                
                const data = await response.json();
                const container = document.getElementById('disponibilidade-hoje');
                
                container.innerHTML = `
                    <p><strong>Data:</strong> ${formatarData(hoje)}</p>
                    <p><strong>Horários disponíveis:</strong> ${data.horarios_disponiveis.length}</p>
                    <div class="time-slots" style="margin-top: 1rem;">
                        ${data.horarios_disponiveis.map(horario => 
                            `<span class="time-slot selected">${horario}</span>`
                        ).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('disponibilidade-hoje').innerHTML = '<p>Erro ao carregar disponibilidade</p>';
            }
        }

        // Configuração Geral
        async function loadConfigGeral() {
            try {
                const token = await getToken();
                const response = await fetch(`/admin/config/${clienteId}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar configuração');
                
                const data = await response.json();
                configGeral = data;
                
                renderDiasSemana(configGeral.dias_semana);
                renderHorariosDisponiveis(configGeral.horarios_disponiveis);
                document.getElementById('intervalo-minutos').value = configGeral.intervalo_minutos;
                document.getElementById('max-agendamentos-dia').value = configGeral.max_agendamentos_dia;
                
            } catch (error) {
                showError('Erro ao carregar configuração: ' + error.message);
            }
        }

        function renderDiasSemana(diasSelecionados) {
            const container = document.getElementById('dias-semana-checkboxes');
            const dias = [
                { id: 0, nome: 'Domingo' },
                { id: 1, nome: 'Segunda' },
                { id: 2, nome: 'Terça' },
                { id: 3, nome: 'Quarta' },
                { id: 4, nome: 'Quinta' },
                { id: 5, nome: 'Sexta' },
                { id: 6, nome: 'Sábado' }
            ];
            
            container.innerHTML = dias.map(dia => `
                <label class="checkbox-label">
                    <input type="checkbox" value="${dia.id}" ${diasSelecionados.includes(dia.id) ? 'checked' : ''}>
                    ${dia.nome}
                </label>
            `).join('');
        }

        function renderHorariosDisponiveis(horarios) {
            const container = document.getElementById('horarios-disponiveis');
            const todosHorarios = [
                '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'
            ];
            
            container.innerHTML = todosHorarios.map(horario => `
                <div class="time-slot ${horarios.includes(horario) ? 'selected' : ''}" 
                     onclick="toggleHorario(this)">
                    ${horario}
                </div>
            `).join('');
        }

        function toggleHorario(element) {
            element.classList.toggle('selected');
        }

        async function salvarConfigGeral() {
            const diasSemana = Array.from(document.querySelectorAll('#dias-semana-checkboxes input:checked'))
                .map(cb => parseInt(cb.value));
            
            const horariosDisponiveis = Array.from(document.querySelectorAll('#horarios-disponiveis .time-slot.selected'))
                .map(slot => slot.textContent.trim());
            
            const config = {
                dias_semana: diasSemana,
                horarios_disponiveis: horariosDisponiveis,
                intervalo_minutos: parseInt(document.getElementById('intervalo-minutos').value),
                max_agendamentos_dia: parseInt(document.getElementById('max-agendamentos-dia').value)
            };
            
            try {
                const token = await getToken();
                const response = await fetch(`/admin/config/${clienteId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(config)
                });
                
                if (!response.ok) throw new Error('Erro ao salvar configuração');
                
                const result = await response.json();
                showSuccess('Configuração salva com sucesso!');
            } catch (error) {
                showError('Erro ao salvar configuração: ' + error.message);
            }
        }

        // Calendário
        async function loadCalendario() {
            renderCalendario30Dias();
            document.getElementById('data-selecionada').value = new Date().toISOString().split('T')[0];
            await loadConfigDataEspecifica();
        }

        function renderCalendario30Dias() {
            const container = document.getElementById('calendario-30dias');
            const hoje = new Date();
            const dias = [];
            
            for (let i = 0; i < 30; i++) {
                const data = new Date(hoje);
                data.setDate(hoje.getDate() + i);
                dias.push(data);
            }
            
            // Encontra o primeiro dia da semana do primeiro dia mostrado
            const primeiroDia = new Date(dias[0]);
            const diff = primeiroDia.getDay(); // 0 = Domingo, 1 = Segunda, etc.
            
            // Cria dias vazios para alinhar o calendário
            const diasVazios = Array(diff).fill(null);
            const todosDias = [...diasVazios, ...dias];
            
            container.innerHTML = `
                <div class="calendar">
                    ${['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(dia => 
                        `<div class="calendar-header">${dia}</div>`
                    ).join('')}
                    ${todosDias.map(dia => {
                        if (!dia) return '<div class="calendar-day"></div>';
                        
                        const isToday = dia.toDateString() === hoje.toDateString();
                        return `
                            <div class="calendar-day ${isToday ? 'today' : ''}" 
                                 onclick="selecionarData('${dia.toISOString().split('T')[0]}')">
                                <div class="day-number">${dia.getDate()}</div>
                                <small>${dia.getDate()}</small>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function selecionarData(data) {
            document.getElementById('data-selecionada').value = data;
            await loadConfigDataEspecifica();
        }

        async function loadConfigDataEspecifica() {
            const data = document.getElementById('data-selecionada').value;
            if (!data) return;
            
            try {
                const token = await getToken();
                const response = await fetch(`/api/horarios-disponiveis/${clienteId}?data=${data}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar disponibilidade');
                
                const disponibilidade = await response.json();
                const container = document.getElementById('config-data-especifica');
                
                // Busca configurações específicas da data
                const configResponse = await fetch(`/admin/config/${clienteId}/datas?startDate=${data}&endDate=${data}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const configData = configResponse.ok ? await configResponse.json() : { configs: [] };
                const configEspecifica = configData.configs[0];
                
                container.innerHTML = `
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="bloquear-data" ${configEspecifica?.bloqueada ? 'checked' : ''} 
                                   onchange="toggleBloqueioData()">
                            Bloquear esta data completamente
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Horários para ${formatarData(data)}</label>
                        <div class="time-slots" id="horarios-data-especifica"></div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="salvarConfigData()">Salvar Configuração da Data</button>
                `;
                
                renderHorariosDataEspecifica(disponibilidade, configEspecifica);
            } catch (error) {
                showError('Erro ao carregar configuração da data: ' + error.message);
            }
        }

        function renderHorariosDataEspecifica(disponibilidade, configEspecifica) {
            const container = document.getElementById('horarios-data-especifica');
            const horariosPermitidos = configGeral.horarios_disponiveis;
            
            container.innerHTML = horariosPermitidos.map(horario => {
                const isDisponivel = disponibilidade.horarios_disponiveis.includes(horario);
                const isBloqueado = configEspecifica?.horarios_bloqueados?.includes(horario);
                
                return `
                    <div class="time-slot ${isDisponivel && !isBloqueado ? 'selected' : ''} ${isBloqueado ? 'ocupado' : ''}" 
                         onclick="toggleHorarioData(this, '${horario}')">
                        ${horario}
                        ${!isDisponivel ? ' (Indisponível)' : ''}
                    </div>
                `;
            }).join('');
        }

        async function toggleBloqueioData() {
            const data = document.getElementById('data-selecionada').value;
            const bloquear = document.getElementById('bloquear-data').checked;
            
            try {
                const token = await getToken();
                const response = await fetch(`/admin/config/${clienteId}/datas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        data: data, 
                        bloqueada: bloquear 
                    })
                });
                
                if (!response.ok) throw new Error('Erro ao bloquear data');
                
                showSuccess(`Data ${bloquear ? 'bloqueada' : 'desbloqueada'} com sucesso!`);
                await loadConfigDataEspecifica();
            } catch (error) {
                showError('Erro ao atualizar bloqueio: ' + error.message);
            }
        }

        function toggleHorarioData(element, horario) {
            element.classList.toggle('selected');
            element.classList.toggle('ocupado');
        }

        async function salvarConfigData() {
            const data = document.getElementById('data-selecionada').value;
            const horariosSelecionados = Array.from(document.querySelectorAll('#horarios-data-especifica .time-slot.selected'))
                .map(slot => slot.textContent.split(' ')[0].trim()); // Remove "(Indisponível)" se existir
            
            const horariosBloqueados = configGeral.horarios_disponiveis.filter(horario => 
                !horariosSelecionados.includes(horario)
            );
            
            try {
                const token = await getToken();
                const response = await fetch(`/admin/config/${clienteId}/datas`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ 
                        data: data,
                        horarios_bloqueados: horariosBloqueados
                    })
                });
                
                if (!response.ok) throw new Error('Erro ao salvar configuração');
                
                showSuccess('Configuração da data salva com sucesso!');
            } catch (error) {
                showError('Erro ao salvar configuração da data: ' + error.message);
            }
        }

        // Agendamentos
        async function carregarAgendamentos() {
            const data = document.getElementById('data-agendamentos').value;
            
            try {
                const token = await getToken();
                const response = await fetch(`/agendamentos/${clienteId}`, {
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao carregar agendamentos');
                
                const result = await response.json();
                const agendamentosDoDia = result.agendamentos.filter(ag => ag.data === data);
                
                const container = document.getElementById('lista-agendamentos');
                container.innerHTML = agendamentosDoDia.map(ag => `
                    <div class="agendamento-item">
                        <div>
                            <strong>${ag.horario}</strong> - ${ag.nome}
                            <br><small>${ag.email} - ${ag.telefone}</small>
                        </div>
                        <div>
                            <span class="status ${ag.status}">${ag.status}</span>
                            <button class="btn btn-success" onclick="confirmarAgendamento('${ag.id}')">Confirmar</button>
                            <button class="btn btn-danger" onclick="cancelarAgendamento('${ag.id}')">Cancelar</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                showError('Erro ao carregar agendamentos: ' + error.message);
            }
        }

        async function confirmarAgendamento(id) {
            try {
                const token = await getToken();
                const response = await fetch(`/agendamentos/${clienteId}/confirmar/${id}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao confirmar agendamento');
                
                showSuccess('Agendamento confirmado com sucesso!');
                await carregarAgendamentos();
            } catch (error) {
                showError('Erro ao confirmar agendamento: ' + error.message);
            }
        }

        async function cancelarAgendamento(id) {
            if (!confirm('Tem certeza que deseja cancelar este agendamento?')) return;
            
            try {
                const token = await getToken();
                const response = await fetch(`/agendamentos/${clienteId}/cancelar/${id}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Erro ao cancelar agendamento');
                
                showSuccess('Agendamento cancelado com sucesso!');
                await carregarAgendamentos();
            } catch (error) {
                showError('Erro ao cancelar agendamento: ' + error.message);
            }
        }

        // Utilitários
        async function getToken() {
            const { data: { session } } = await supabase.auth.getSession();
            return session?.access_token;
        }

        function formatarData(data) {
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }

        function showError(message) {
            // Remove mensagens anteriores
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.main-content').prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            // Remove mensagens anteriores
            document.querySelectorAll('.error, .success').forEach(el => el.remove());
            
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.main-content').prepend(successDiv);
            setTimeout(() => successDiv.remove(), 5000);
        }
    </script>
</body>
</html>
