<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agendamento</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<style>
  .glass-card {
    background: linear-gradient(135deg, rgba(30,40,60,0.3), rgba(50,60,80,0.3));
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(12px);
  }
  #meusAgendamentos { max-height: 500px; overflow-y: auto; }
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-700 to-slate-900 text-white font-sans">

<div class="container mx-auto px-4 py-12 max-w-4xl">

  <!-- Login Section -->
  <div id="loginSection" class="glass-card rounded-xl p-8 mb-8 shadow-xl" data-aos="fade-up">
      <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
          <i data-feather="lock" class="w-5 h-5"></i>
          Acesso ao Sistema
      </h2>
      <div class="space-y-4">
          <div>
              <label for="email" class="block mb-1 text-sm font-medium">Email</label>
              <input type="email" id="email" placeholder="seu@email.com" 
                     class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-300">
          </div>
          <div>
              <label for="senha" class="block mb-1 text-sm font-medium">Senha</label>
              <input type="password" id="senha" placeholder="••••••••" 
                     class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-purple-300">
          </div>
          <button id="loginBtn" class="w-full bg-white text-purple-700 py-3 px-6 rounded-lg font-medium hover:bg-gray-100 transition-all flex items-center justify-center gap-2">
              <i data-feather="log-in" class="w-5 h-5"></i>
              Entrar
          </button>
      </div>
  </div>

  <!-- Appointment Form -->
  <form id="agendamentoForm" style="display:none;" class="glass-card rounded-xl p-8 mb-8 shadow-xl hover:scale-105 transition-transform" data-aos="fade-up">
      <h2 class="text-2xl font-semibold mb-6 flex items-center gap-2">
          <i data-feather="calendar" class="w-5 h-5"></i>
          Novo Agendamento
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-4">
              <input type="text" name="Nome" placeholder="Nome" required class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20">
              <input type="email" name="Email" placeholder="Email" required class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20">
          </div>
          <div class="space-y-4">
              <input type="text" name="Telefone" placeholder="Telefone" required class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20">
              <input type="date" name="Data" required class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20">
              <input type="time" name="Horario" required class="w-full px-4 py-3 rounded-lg bg-white/10 border border-white/20">
          </div>
      </div>
      <button type="submit" class="mt-6 w-full bg-purple-600 text-white py-3 rounded-lg">Agendar</button>
  </form>

</div>

<script>
feather.replace();

let userToken = null;
const loginSection = document.getElementById('loginSection');
const agendamentoForm = document.getElementById('agendamentoForm');
const loginBtn = document.getElementById('loginBtn');
const cliente = window.location.pathname.split('/')[1] || '';

loginBtn.addEventListener('click', async () => {
    const email = document.getElementById('email').value;
    const senha = document.getElementById('senha').value;
    try {
        const res = await fetch(`/login`, { 
            method: 'POST',
            headers: { 'Content-Type':'application/json' },
            body: JSON.stringify({ email, senha })
        });
        const data = await res.json();
        if(res.ok){
            userToken = data.token;
            loginSection.style.display = 'none';
            agendamentoForm.style.display = 'block';
        } else {
            alert(data.msg || 'Erro ao logar');
        }
    } catch(e) {
        console.error(e);
        alert('Erro de conexão');
    }
});

// Submit do agendamento
agendamentoForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(agendamentoForm).entries());
    try {
        const res = await fetch(`/agendar/${cliente}`, {
            method: 'POST',
            headers: {
                'Content-Type':'application/json',
                'Authorization': `Bearer ${userToken}`
            },
            body: JSON.stringify(formData)
        });
        const data = await res.json();
        if(res.ok || res.status===409){
            alert('Agendamento realizado!');
            agendamentoForm.reset();
        } else {
            alert(data.msg || 'Erro ao agendar');
        }
    } catch(e){
        console.error(e);
        alert('Erro de conexão');
    }
});
</script>

</body>
</html>
