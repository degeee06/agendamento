<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agendamento</title>
<style>
body { font-family: Arial; max-width: 500px; margin: 50px auto; padding: 20px; background: #f7f7f7; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
h2 { text-align: center; margin-bottom: 20px; }
input, button { width: 100%; padding: 12px; margin: 10px 0; border-radius: 6px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
button { background: #4CAF50; color: white; border: none; cursor: pointer; transition: 0.2s; }
button:hover { background: #45a049; }
.success, .error { text-align: center; margin-top: 15px; font-weight: bold; }
.success { color: green; }
.error { color: red; }
</style>
</head>
<body>

<h2>Login</h2>
<form id="loginForm">
  <input type="email" name="email" placeholder="Email" required>
  <input type="password" name="senha" placeholder="Senha" required>
  <button type="submit">Entrar</button>
</form>
<div class="error" id="loginMsg" style="display:none;"></div>

<div id="agendamentoContainer" style="display:none;">
<h2>Formulário de Agendamento</h2>
<form id="agendamentoForm">
  <input type="text" name="Nome" placeholder="Nome" required>
  <input type="email" name="Email" placeholder="Email" required>
  <input type="text" name="Telefone" placeholder="Telefone" required>
  <input type="date" name="Data" placeholder="Data do Agendamento" required>
  <input type="time" name="Horario" placeholder="Horário" required>
  <button type="submit">Agendar</button>
</form>

<div class="success" id="successMsg" style="display:none;">✅ Agendamento realizado!</div>
<div class="error" id="errorMsg" style="display:none;">❌ Ocorreu um erro</div>
</div>

<script>
const loginForm = document.getElementById("loginForm");
const loginMsg = document.getElementById("loginMsg");
const agendamentoContainer = document.getElementById("agendamentoContainer");

const agendamentoForm = document.getElementById("agendamentoForm");
const successMsg = document.getElementById("successMsg");
const errorMsg = document.getElementById("errorMsg");

let token = localStorage.getItem("token");
let clienteId = null;

async function fetchClienteId() {
  if(!token) return;
  try {
    const res = await fetch("/minhas-info", { headers: { "Authorization": "Bearer " + token } });
    if(res.ok){
      const data = await res.json();
      clienteId = data.cliente.id;
      agendamentoContainer.style.display = "block";
      loginForm.style.display = "none";
    } else {
      localStorage.removeItem("token");
    }
  } catch(err) { console.error(err); }
}

fetchClienteId();

// Login
loginForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  loginMsg.style.display = 'none';
  const email = loginForm.email.value;
  const senha = loginForm.senha.value;

  try {
    const res = await fetch("/login", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ email, senha })
    });
    const data = await res.json();
    if(res.ok){
      token = data.token;
      localStorage.setItem("token", token);
      await fetchClienteId();
    } else {
      loginMsg.textContent = data.msg || "Erro no login";
      loginMsg.style.display = "block";
    }
  } catch(err){
    console.error(err);
    loginMsg.textContent = "Erro no login";
    loginMsg.style.display = "block";
  }
});

// Agendamento
agendamentoForm.addEventListener("submit", async(e)=>{
  e.preventDefault();
  successMsg.style.display='none';
  errorMsg.style.display='none';
  
  const formData = new FormData(agendamentoForm);
  const data = {};
  formData.forEach((v,k)=>data[k]=v);

  try {
    // Verifica se horário ocupado
    const check = await fetch(`/disponiveis/${clienteId}/${data.Data}`, { headers: { "Authorization": "Bearer " + token } });
    const result = await check.json();
    if(result.ocupados.includes(data.Horario)){
      errorMsg.textContent='Horário já ocupado';
      errorMsg.style.display='block';
      return;
    }
  } catch(err){ console.error(err); }

  try {
    const res = await fetch(`/agendar/${clienteId}`, {
      method:'POST',
      headers:{ 'Content-Type':'application/json', "Authorization":"Bearer "+token },
      body: JSON.stringify(data)
    });
    const result = await res.json();
    if(res.ok){ successMsg.style.display='block'; agendamentoForm.reset(); }
    else { errorMsg.textContent=result.msg || 'Erro'; errorMsg.style.display='block'; }
  } catch(err){
    console.error(err);
    errorMsg.textContent='Erro';
    errorMsg.style.display='block';
  }
});
</script>

</body>
</html>
