<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agendamento</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
<script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
<script src="https://unpkg.com/feather-icons"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  .glass-card {
      background: linear-gradient(135deg, rgba(30,40,60,0.3), rgba(50,60,80,0.3));
      border: 1px solid rgba(255,255,255,0.1);
      backdrop-filter: blur(12px);
  }
  .scrollbar-hide::-webkit-scrollbar { display: none; }
  .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

  #meusAgendamentos {
    max-height: 500px;
    overflow-y: auto;
  }
</style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-700 to-slate-900 text-white font-sans">

<div class="container mx-auto px-4 py-12 max-w-4xl">
  <!-- Header e Login / Form já como no seu template -->
</div>

<!-- Toasts -->
<div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50"></div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const SUPABASE_URL = "https://otyxjcxxqwjotnuyrvmc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90eXhqY3h4cXdqb3RudXlydm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzU5MTQsImV4cCI6MjA3MzAxMTkxNH0.O6pWtKMQvsIQlOt7G6nIcDMMKoTJU-G-qpZiiE6Q3Hk";
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let userToken = null;
let agendamentosCache = [];
let diaSelecionado = 1;

const form = document.getElementById('agendamentoForm');
const loginBtn = document.getElementById('loginBtn');
const loginSection = document.getElementById('loginSection');
const meusAgendamentos = document.getElementById('meusAgendamentos');
const searchInput = document.getElementById("searchInput");
const statusFilter = document.getElementById("statusFilter");
const exportCSVBtn = document.getElementById("exportCSVBtn");
const exportPDFBtn = document.getElementById("exportPDFBtn");
const diasTabs = document.querySelectorAll(".tab-dia");

const pathParts = window.location.pathname.split('/');
const cliente = pathParts[1] || '';

function formatData(data){ const [y,m,d] = data.split("-"); return `${d}/${m}/${y}`; }

function showToast(message, type = "success") {
  const colors = { success:"bg-green-600", error:"bg-red-600", info:"bg-blue-600", warning:"bg-yellow-600"};
  const container = document.getElementById("toast-container");
  const toast = document.createElement("div");
  toast.className = `p-4 rounded-lg shadow-md text-white font-medium ${colors[type]} opacity-0 translate-x-5 transition-all duration-500 flex items-center gap-2`;
  toast.innerHTML = `<i data-feather="${type==="success"?"check-circle":type==="error"?"alert-circle":"info"}" class="w-5 h-5"></i> <span>${message}</span>`;
  container.appendChild(toast);
  feather.replace();
  requestAnimationFrame(()=>{ toast.classList.remove("opacity-0","translate-x-5"); toast.classList.add("opacity-100","translate-x-0"); });
  setTimeout(()=>{ toast.classList.add("opacity-0","translate-x-5"); setTimeout(()=>toast.remove(),500); },3000);
}

// --- Login ---
loginBtn.addEventListener('click', async ()=>{
  const email = document.getElementById('email').value;
  const senha = document.getElementById('senha').value;
  const { data, error } = await supabase.auth.signInWithPassword({ email, password: senha });
  if(error){ showToast(error.message,"error"); return; }
  userToken = data.session.access_token;
  loginSection.style.display = 'none';
  form.style.display = 'block';
  listarAgendamentos();
});

// --- Listar e Renderizar ---
async function listarAgendamentos(){
  if(!userToken) return;
  try{
    const res = await fetch(`/meus-agendamentos/${cliente}`, { headers: { "Authorization": `Bearer ${userToken}` } });
    const { agendamentos } = await res.json();
    agendamentosCache = agendamentos;
    meusAgendamentos.style.display='block';
    document.getElementById('filtersSection').style.display='block';
    document.getElementById('diasTabs').style.display='flex';
    diaSelecionado = new Date().getDay() || 1;
    renderAgendamentos();
  }catch(e){ console.error(e); showToast("Erro ao listar agendamentos","error"); }
}

function renderAgendamentos(){
  const filtroNome = searchInput.value.toLowerCase();
  const filtroStatus = statusFilter.value;
  const filtrados = agendamentosCache.filter(a=> ((a.nome+a.email).toLowerCase().includes(filtroNome)) && (filtroStatus?a.status===filtroStatus:true))
                                     .filter(a=> new Date(`${a.data}T${a.horario}`).getDay()===diaSelecionado)
                                     .sort((a,b)=>new Date(`${a.data}T${a.horario}`)-new Date(`${b.data}T${b.horario}`));
  meusAgendamentos.innerHTML = '';
  if(filtrados.length===0){ 
    meusAgendamentos.innerHTML=`<div class='text-center py-8 text-gray-300'>Nenhum agendamento.</div>`; 
    return; 
  }
  filtrados.forEach(a=>{
    const div = document.createElement("div");
    div.className = `agendamento ${a.status} glass-card rounded-xl p-4 mb-4 shadow hover:scale-105 transition-transform`;
    div.innerHTML = `
      <strong>${formatData(a.data)} ${a.horario}</strong>
      <div><strong>Nome:</strong> ${a.nome}</div>
      <div><strong>Email:</strong> ${a.email}</div>
      <div><strong>Telefone:</strong> ${a.telefone}</div>
      <div><strong>Status:</strong> ${a.status}</div>
      <div class="mt-2 flex gap-2">
        ${!a.confirmado&&a.status!=="cancelado"?`<button data-action="confirmar" data-id="${a.id}" class="px-3 py-1 bg-green-600 rounded text-white">Confirmar</button>`:""}
        ${a.status!=="cancelado"?`<button data-action="cancelar" data-id="${a.id}" class="px-3 py-1 bg-red-600 rounded text-white">Cancelar</button>`:""}
      </div>
    `;
    meusAgendamentos.appendChild(div);

    const confirmBtn = div.querySelector('button[data-action="confirmar"]');
    if(confirmBtn) confirmBtn.addEventListener("click", async ()=>{
      try{
        const res = await fetch(`/confirmar/${cliente}/${a.id}`,{method:"POST",headers:{"Authorization":`Bearer ${userToken}`}});
        if(res.ok){ showToast("Agendamento confirmado!","success"); listarAgendamentos(); } 
        else { const result = await res.json(); showToast(result.msg || "Erro ao confirmar","error"); }
      }catch(e){ console.error(e); showToast("Erro de conexão","error"); }
    });

    const cancelBtn = div.querySelector('button[data-action="cancelar"]');
    if(cancelBtn) cancelBtn.addEventListener("click", async ()=>{
      try{
        const res = await fetch(`/cancelar/${cliente}/${a.id}`,{method:"POST",headers:{"Authorization":`Bearer ${userToken}`}});
        if(res.ok){ showToast("Agendamento cancelado!","warning"); listarAgendamentos(); } 
        else { const result = await res.json(); showToast(result.msg || "Erro ao cancelar","error"); }
      }catch(e){ console.error(e); showToast("Erro de conexão","error"); }
    });
  });
}

// --- Filtros / Tabs / Export CSV / PDF --- (mesmo que antes)
searchInput.addEventListener("input", renderAgendamentos);
statusFilter.addEventListener("change", renderAgendamentos);
diasTabs.forEach(tab=>{
  tab.addEventListener("click", ()=>{
    diasTabs.forEach(t=>t.classList.replace("bg-purple-600","bg-white/10"));
    tab.classList.replace("bg-white/10","bg-purple-600");
    diaSelecionado = parseInt(tab.dataset.dia);
    renderAgendamentos();
  });
});

// --- Form Agendamento ---
form.addEventListener("submit", async (e)=>{
  e.preventDefault();
  const formData = new FormData(form);
  const data = Object.fromEntries(formData.entries());
  try{
    const res = await fetch(`/agendar/${cliente}`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${userToken}`
      },
      body:JSON.stringify(data)
    });
    const result = await res.json();
    if(res.ok){
      showToast(result.msg || "Agendamento criado!","success");
      form.reset();
      listarAgendamentos();
    } else {
      showToast(result.msg || "Erro ao agendar","error");
    }
  }catch(e){
    console.error(e);
    showToast("Erro de conexão","error");
  }
});

AOS.init();
feather.replace();
</script>
</body>
</html>
