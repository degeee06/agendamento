<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agendamento</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
</head>
<body>
  <h1>Agendamento</h1>
  <div id="loginDiv">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Senha"><br>
    <button id="btnLogin">Entrar</button>
    <button id="btnMagic">Entrar com link mágico</button>
    <p id="loginMsg"></p>
  </div>

  <div id="agendaDiv" style="display:none">
    <h2>Agendar horário</h2>
    <input type="text" id="nome" placeholder="Nome"><br>
    <input type="email" id="emailForm" placeholder="Email"><br>
    <input type="text" id="telefone" placeholder="Telefone"><br>
    <input type="date" id="data"><br>
    <input type="time" id="horario"><br>
    <button id="btnAgendar">Agendar</button>
    <p id="agendaMsg"></p>
  </div>

  <!-- SCRIPT NO FINAL DO BODY -->
  <script>
    // Inicializa supabase primeiro
    const supabaseUrl = "https://otyxjcxxqwjotnuyrvmc.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90eXhqY3h4cXdqb3RudXlydm1jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzU5MTQsImV4cCI6MjA3MzAxMTkxNH0.O6pWtKMQvsIQlOt7G6nIcDMMKoTJU-G-qpZiiE6Q3Hk";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const clienteId = window.location.pathname.split("/")[1];

    // Processa magic link
    window.addEventListener('load', async () => {
      const hash = window.location.hash;
      if (hash.includes("access_token")) {
        const params = new URLSearchParams(hash.slice(1));
        const access_token = params.get("access_token");
        await supabase.auth.setSession({ access_token });
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("agendaDiv").style.display = "block";
        window.location.hash = "";
      }
    });

    // Login
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      console.log("Login data:", data, "Error:", error);
      if (error) { document.getElementById("loginMsg").innerText = error.message; return; }
      if (data.session) {
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("agendaDiv").style.display = "block";
      } else {
        document.getElementById("loginMsg").innerText = "Não foi possível iniciar a sessão";
      }
    }

    async function loginMagic() {
      const email = document.getElementById("email").value;
      const { data, error } = await supabase.auth.signInWithOtp({ email });
      if (error) { document.getElementById("loginMsg").innerText = error.message; return; }
      document.getElementById("loginMsg").innerText = "✅ Confira seu e-mail para entrar!";
    }

    async function agendar() {
      const { data: { session } } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) { document.getElementById("agendaMsg").innerText = "❌ Usuário não autenticado"; return; }

      const registro = {
        Nome: document.getElementById("nome").value,
        Email: document.getElementById("emailForm").value,
        Telefone: document.getElementById("telefone").value,
        Data: document.getElementById("data").value,
        Horario: document.getElementById("horario").value
      };

      const res = await fetch(`/agendar/${clienteId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
        body: JSON.stringify(registro)
      });

      const data = await res.json();
      document.getElementById("agendaMsg").innerText = data.msg;
    }

    // Event listeners
    document.getElementById("btnLogin").addEventListener("click", login);
    document.getElementById("btnMagic").addEventListener("click", loginMagic);
    document.getElementById("btnAgendar").addEventListener("click", agendar);
  </script>
</body>
</html>

