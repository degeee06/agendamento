<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agendamento</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/supabase.min.js"></script>
</head>
<body>
  <h1>Agendamento</h1>

  <!-- LOGIN -->
  <div id="loginDiv">
    <h2>Login</h2>
    <input type="email" id="email" placeholder="Email"><br>
    <input type="password" id="password" placeholder="Senha"><br>
    <button onclick="login()">Entrar</button>
    <button onclick="loginMagic()">Entrar com link mágico</button>
    <p id="loginMsg"></p>
  </div>

  <!-- FORMULÁRIO DE AGENDAMENTO -->
  <div id="agendaDiv" style="display:none">
    <h2>Agendar horário</h2>
    <input type="text" id="nome" placeholder="Nome"><br>
    <input type="email" id="emailForm" placeholder="Email"><br>
    <input type="text" id="telefone" placeholder="Telefone"><br>
    <input type="date" id="data"><br>
    <input type="time" id="horario"><br>
    <button onclick="agendar()">Agendar</button>
    <p id="agendaMsg"></p>
  </div>

  <script>
    // ----------- CONFIGURAÇÃO SUPABASE -------------
    const supabaseUrl = "https://SEU_SUPABASE_URL"; // substitua
    const supabaseKey = "SEU_SUPABASE_ANON_KEY";    // substitua
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // ----------- DETECTAR CLIENTE NA URL -------------
    const clienteId = window.location.pathname.split("/")[1]; // "/cliente1" -> "cliente1"

    // ----------- PROCESSAR LINK MÁGICO AO CARREGAR A PÁGINA -------------
    window.addEventListener('load', async () => {
      const hash = window.location.hash;
      if (hash.includes("access_token")) {
        const params = new URLSearchParams(hash.slice(1));
        const access_token = params.get("access_token");
        await supabase.auth.setSession({ access_token });
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("agendaDiv").style.display = "block";
      }
    });

    // ----------- FUNÇÃO LOGIN COM EMAIL/SENHA -------------
    async function login() {
      const email = document.getElementById("email").value;
      const password = document.getElementById("password").value;
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        document.getElementById("loginMsg").innerText = error.message;
        return;
      }

      if (data.session) {
        document.getElementById("loginDiv").style.display = "none";
        document.getElementById("agendaDiv").style.display = "block";
      } else {
        document.getElementById("loginMsg").innerText = "Não foi possível iniciar a sessão";
      }
    }

    // ----------- FUNÇÃO LOGIN COM LINK MÁGICO -------------
    async function loginMagic() {
      const email = document.getElementById("email").value;
      const { data, error } = await supabase.auth.signInWithOtp({ email });

      if (error) {
        document.getElementById("loginMsg").innerText = error.message;
        return;
      }

      document.getElementById("loginMsg").innerText = "✅ Confira seu e-mail para entrar!";
    }

    // ----------- FUNÇÃO PARA AGENDAR -------------
    async function agendar() {
      // Pega o token atual da sessão
      const { data: { session } } = await supabase.auth.getSession();
      const token = session?.access_token;
      if (!token) {
        document.getElementById("agendaMsg").innerText = "❌ Usuário não autenticado";
        return;
      }

      const registro = {
        Nome: document.getElementById("nome").value,
        Email: document.getElementById("emailForm").value,
        Telefone: document.getElementById("telefone").value,
        Data: document.getElementById("data").value,
        Horario: document.getElementById("horario").value
      };

      const res = await fetch(`/agendar/${clienteId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + token
        },
        body: JSON.stringify(registro)
      });

      const data = await res.json();
      document.getElementById("agendaMsg").innerText = data.msg;
    }
  </script>
</body>
</html>
